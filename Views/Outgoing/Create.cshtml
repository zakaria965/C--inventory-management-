@model InventoryManagementSystem.Models.Outgoing
@{
    ViewData["Title"] = "Outgoing Product";
    Layout = "_DashboardLayout";
}

<div class="container">
    <h1>Record Outgoing Product</h1>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }

    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px;">
        <form asp-action="Create" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div style="margin-bottom: 15px;">
                <label asp-for="ProductId" style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
                <select asp-for="ProductId" id="ProductId" asp-items="ViewBag.ProductId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select Product --</option>
                </select>
                <span asp-validation-for="ProductId" class="text-danger"></span>
                <small id="returnInfo" style="display: none; color: #28a745; margin-top: 5px; display: block; font-weight: 500;">
                    ℹ️ Return selected: Product will be added back to inventory
                </small>
            </div>

            <div style="margin-bottom: 15px;">
                <label asp-for="Quantity" style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
                <input asp-for="Quantity" id="Quantity" type="number" min="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                <span asp-validation-for="Quantity" class="text-danger"></span>
            </div>

            <div style="margin-bottom: 15px;">
                <label asp-for="Reason" style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
                <select asp-for="Reason" id="Reason" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="Sale">Sale</option>
                    <option value="Damage">Damage</option>
                    <option value="Transfer">Transfer</option>
                    <option value="Return">Return</option>
                </select>
                <span asp-validation-for="Reason" class="text-danger"></span>
            </div>

            <div style="margin-bottom: 15px;">
                <label asp-for="OrderId" style="display: block; margin-bottom: 5px; font-weight: bold;">Link to Order (Optional)</label>
                <select asp-for="OrderId" id="OrderId" asp-items="ViewBag.OrderId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- No Order --</option>
                </select>
                <span asp-validation-for="OrderId" class="text-danger"></span>
                <small id="orderInfo" style="display: none; color: #28a745; margin-top: 5px; display: block;"></small>
            </div>

            <div style="margin-bottom: 15px;">
                <label asp-for="OutgoingPrice" style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
                <input asp-for="OutgoingPrice" id="OutgoingPrice" type="number" step="0.01" min="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                <span asp-validation-for="OutgoingPrice" class="text-danger"></span>
            </div>

            <div style="margin-bottom: 15px;">
                <label asp-for="Recipient" style="display: block; margin-bottom: 5px; font-weight: bold;">Customer/Recipient</label>
                <input asp-for="Recipient" id="Recipient" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                <span asp-validation-for="Recipient" class="text-danger"></span>
            </div>

            <div style="margin-bottom: 15px;">
                <label asp-for="Notes" style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
                <textarea asp-for="Notes" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                <span asp-validation-for="Notes" class="text-danger"></span>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" style="background-color: #3510aeff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">Record Outgoing</button>
                <a href="/Outgoing/History" style="background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const orderSelect = document.getElementById('OrderId');
            const productSelect = document.getElementById('ProductId');
            const quantityInput = document.getElementById('Quantity');
            const priceInput = document.getElementById('OutgoingPrice');
            const recipientInput = document.getElementById('Recipient');
            const orderInfo = document.getElementById('orderInfo');
            const reasonSelect = document.getElementById('Reason');
            const returnInfo = document.getElementById('returnInfo');

            // Store original values to restore if order is deselected
            let originalValues = {
                product: '',
                quantity: '',
                price: '',
                recipient: '',
                reason: 'Sale',
                notes: ''
            };

            // Store all products for return selection
            let allProducts = [];
            
            // Load all products for return option
            async function loadAllProducts() {
                try {
                    const response = await fetch('/Outgoing/GetAllProducts');
                    const data = await response.json();
                    if (data.success) {
                        allProducts = data.products;
                    }
                } catch (error) {
                    console.error('Error loading products:', error);
                }
            }
            
            // Load products on page load
            loadAllProducts();

            // Handle reason change
            reasonSelect.addEventListener('change', function() {
                const isReturn = this.value === 'Return';
                
                if (isReturn) {
                    // Show return info message
                    returnInfo.style.display = 'block';
                    
                    // Update product dropdown to include all products (even with 0 stock)
                    updateProductListForReturn();
                } else {
                    // Hide return info message
                    returnInfo.style.display = 'none';
                    
                    // Update product dropdown to only show products with stock > 0
                    updateProductListForOutgoing();
                }
            });

            function updateProductListForReturn() {
                // Save current selection
                const currentValue = productSelect.value;
                
                // Clear and rebuild options with all products
                productSelect.innerHTML = '<option value="">-- Select Product --</option>';
                
                if (allProducts.length > 0) {
                    allProducts.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (Stock: ${product.stock})`;
                        productSelect.appendChild(option);
                    });
                } else {
                    // Fallback: fetch products via AJAX
                    fetch('/Outgoing/GetAllProducts')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                data.products.forEach(product => {
                                    const option = document.createElement('option');
                                    option.value = product.id;
                                    option.textContent = `${product.name} (Stock: ${product.stock})`;
                                    productSelect.appendChild(option);
                                });
                                // Restore selection if it exists
                                if (currentValue) {
                                    productSelect.value = currentValue;
                                }
                            }
                        });
                }
                
                // Restore selection if it exists
                if (currentValue) {
                    productSelect.value = currentValue;
                }
            }

            function updateProductListForOutgoing() {
                // Save current selection
                const currentValue = productSelect.value;
                
                // Clear and rebuild options with only products that have stock > 0
                productSelect.innerHTML = '<option value="">-- Select Product --</option>';
                
                if (allProducts.length > 0) {
                    allProducts
                        .filter(product => product.stock > 0)
                        .forEach(product => {
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} (Stock: ${product.stock})`;
                            productSelect.appendChild(option);
                        });
                } else {
                    // Fallback: reload from server
                    window.location.reload();
                }
                
                // Restore selection if it exists and is valid
                if (currentValue) {
                    const selectedProduct = allProducts.find(p => p.id == currentValue);
                    if (selectedProduct && selectedProduct.stock > 0) {
                        productSelect.value = currentValue;
                    }
                }
            }

            orderSelect.addEventListener('change', async function() {
                const orderId = this.value;

                if (!orderId || orderId === '') {
                    // No order selected - restore manual input mode
                    restoreManualInput();
                    orderInfo.style.display = 'none';
                    // Enable all fields for manual input
                    enableManualInput();
                    return;
                }

                // Show loading
                orderInfo.style.display = 'block';
                orderInfo.style.color = '#17a2b8';
                orderInfo.textContent = 'Loading order details...';

                try {
                    console.log('Fetching order details for ID:', orderId);
                    const response = await fetch(`/Outgoing/GetOrderDetails/${orderId}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Order data received:', data);

                    if (data.success && data.items && data.items.length > 0) {
                        // Save current values before auto-filling
                        const notesField = document.getElementById('Notes');
                        originalValues = {
                            product: productSelect.value,
                            quantity: quantityInput.value,
                            price: priceInput.value,
                            recipient: recipientInput.value,
                            reason: reasonSelect.value,
                            notes: notesField ? notesField.value : ''
                        };

                        // Auto-fill ALL fields from order
                        autoFillFromOrder(data);

                        // Show success message
                        orderInfo.style.color = '#28a745';
                        if (data.items.length > 1) {
                            orderInfo.innerHTML = `✓ Order <strong>${data.orderNumber}</strong> loaded! <strong>${data.items.length} items</strong> found. First item auto-filled. You can change any field if needed.`;
                        } else {
                            orderInfo.innerHTML = `✓ Order <strong>${data.orderNumber}</strong> loaded! All fields auto-filled from order.`;
                        }
                    } else {
                        // Order has no items but still fill customer info if available
                        orderInfo.style.color = '#ffc107';
                        orderInfo.textContent = data.message || 'Order has no items. Please fill manually.';
                        
                        if (data.customerName) {
                            recipientInput.value = data.customerName;
                        }
                        if (data.shippingAddress) {
                            // Note: Shipping address could be added to Notes if needed
                            const notesField = document.getElementById('Notes');
                            if (notesField && !notesField.value) {
                                notesField.value = `Shipping Address: ${data.shippingAddress}`;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading order details:', error);
                    orderInfo.style.color = '#dc3545';
                    orderInfo.textContent = 'Error loading order details. Please fill manually.';
                }
            });

            function autoFillFromOrder(orderData) {
                console.log('Auto-filling from order:', orderData); // Debug log
                
                // Auto-fill Product (use first item)
                if (orderData.items && orderData.items.length > 0) {
                    const firstItem = orderData.items[0];
                    
                    // Ensure the product exists in the dropdown, if not, add it
                    let productOption = productSelect.querySelector(`option[value="${firstItem.productId}"]`);
                    if (!productOption && allProducts.length > 0) {
                        // Find product in allProducts array
                        const product = allProducts.find(p => p.id == firstItem.productId);
                        if (product) {
                            // Add the product option to the dropdown
                            const option = document.createElement('option');
                            option.value = product.id;
                            option.textContent = `${product.name} (Stock: ${product.stock})`;
                            productSelect.appendChild(option);
                        } else {
                            // Fetch product details if not in allProducts
                            fetch(`/Outgoing/GetAllProducts`)
                                .then(response => response.json())
                                .then(productsData => {
                                    if (productsData.success) {
                                        const product = productsData.products.find(p => p.id == firstItem.productId);
                                        if (product) {
                                            const option = document.createElement('option');
                                            option.value = product.id;
                                            option.textContent = `${product.name} (Stock: ${product.stock})`;
                                            productSelect.appendChild(option);
                                            productSelect.value = firstItem.productId;
                                        }
                                    }
                                });
                        }
                    }
                    
                    // Set product
                    if (firstItem.productId) {
                        productSelect.value = firstItem.productId;
                        console.log('Product set to:', firstItem.productId); // Debug log
                    }
                    
                    // Set quantity
                    if (firstItem.quantity) {
                        quantityInput.value = firstItem.quantity;
                        console.log('Quantity set to:', firstItem.quantity); // Debug log
                    }
                    
                    // Set price
                    if (firstItem.unitPrice) {
                        priceInput.value = parseFloat(firstItem.unitPrice).toFixed(2);
                        console.log('Price set to:', firstItem.unitPrice); // Debug log
                    }
                }

                // Auto-fill Customer/Recipient
                if (orderData.customerName) {
                    recipientInput.value = orderData.customerName;
                    console.log('Recipient set to:', orderData.customerName); // Debug log
                }

                // Auto-fill Reason (set to "Sale" for orders)
                reasonSelect.value = 'Sale';
                console.log('Reason set to: Sale'); // Debug log

                // Auto-fill Notes with order information
                const notesField = document.getElementById('Notes');
                if (notesField) {
                    let notesContent = [];
                    if (orderData.orderNumber) {
                        notesContent.push(`Order: ${orderData.orderNumber}`);
                    }
                    if (orderData.customerEmail) {
                        notesContent.push(`Email: ${orderData.customerEmail}`);
                    }
                    if (orderData.customerPhone) {
                        notesContent.push(`Phone: ${orderData.customerPhone}`);
                    }
                    if (orderData.shippingAddress) {
                        notesContent.push(`Shipping: ${orderData.shippingAddress}`);
                    }
                    if (orderData.notes) {
                        notesContent.push(`Order Notes: ${orderData.notes}`);
                    }
                    if (orderData.items && orderData.items.length > 1) {
                        notesContent.push(`\nOrder Items: ${orderData.items.map(item => `${item.productName} (Qty: ${item.quantity})`).join(', ')}`);
                    }
                    
                    notesField.value = notesContent.join('\n');
                    console.log('Notes set'); // Debug log
                }
                
                // Trigger change events to ensure validation
                productSelect.dispatchEvent(new Event('change'));
                quantityInput.dispatchEvent(new Event('input'));
                priceInput.dispatchEvent(new Event('input'));
            }

            function enableManualInput() {
                // All fields are already enabled, but we can add visual indication if needed
                // Fields remain editable even when auto-filled
            }

            function restoreManualInput() {
                // Restore original values if they existed, otherwise clear fields
                if (originalValues.product) {
                    productSelect.value = originalValues.product;
                } else {
                    productSelect.value = '';
                }
                
                if (originalValues.quantity) {
                    quantityInput.value = originalValues.quantity;
                } else {
                    quantityInput.value = '';
                }
                
                if (originalValues.price) {
                    priceInput.value = originalValues.price;
                } else {
                    priceInput.value = '';
                }
                
                if (originalValues.recipient) {
                    recipientInput.value = originalValues.recipient;
                } else {
                    recipientInput.value = '';
                }
                
                if (originalValues.reason) {
                    reasonSelect.value = originalValues.reason;
                } else {
                    reasonSelect.value = 'Sale';
                }
                
                const notesField = document.getElementById('Notes');
                if (notesField) {
                    if (originalValues.notes) {
                        notesField.value = originalValues.notes;
                    } else {
                        notesField.value = '';
                    }
                }
            }

            // Allow manual editing even after auto-fill
            // The user can still modify any field after auto-fill
        });
    </script>
}

<style>
    .alert { padding: 12px 20px; margin-bottom: 20px; border-radius: 4px; }
    .alert-danger { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
    .text-danger { color: #dc3545; font-size: 14px; }
</style>
