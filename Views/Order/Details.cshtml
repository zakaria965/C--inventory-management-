@model InventoryManagementSystem.Models.Order
@{
    ViewData["Title"] = "Order Details";
    Layout = "_DashboardLayout";
}

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Order Details</h1>
        <div style="display: flex; gap: 10px;">
            <a href="/Order" style="background-color: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px;">Back to List</a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
            <div>
                <h3 style="color: #2d5a5a; margin-top: 0; border-bottom: 2px solid #2d5a5a; padding-bottom: 10px;">Order Information</h3>
                <p><strong>Order Number:</strong> @Model.OrderNumber</p>
                <p><strong>Order Date:</strong> @Model.OrderDate.ToString("yyyy-MM-dd HH:mm")</p>
                <p><strong>Status:</strong> 
                    @{
                        var statusColor = Model.Status switch
                        {
                            "Pending" => "#ffc107",
                            "Processing" => "#17a2b8",
                            "Shipped" => "#007bff",
                            "Delivered" => "#28a745",
                            "Cancelled" => "#dc3545",
                            _ => "#6c757d"
                        };
                    }
                    <span style="background: @statusColor; color: white; padding: 4px 12px; border-radius: 4px; font-size: 14px;">@Model.Status</span>
                </p>
            </div>
            <div>
                <h3 style="color: #2d5a5a; margin-top: 0; border-bottom: 2px solid #2d5a5a; padding-bottom: 10px;">Customer Information</h3>
                <p><strong>Name:</strong> @(Model.CustomerName ?? "N/A")</p>
                <p><strong>Email:</strong> @(Model.CustomerEmail ?? "N/A")</p>
                <p><strong>Phone:</strong> @(Model.CustomerPhone ?? "N/A")</p>
                @if (!string.IsNullOrEmpty(Model.ShippingAddress))
                {
                    <p><strong>Shipping Address:</strong> @Model.ShippingAddress</p>
                }
            </div>
        </div>

        <h3 style="color: #2d5a5a; margin-top: 30px; border-bottom: 2px solid #2d5a5a; padding-bottom: 10px;">Order Items</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #ddd;">Product</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Quantity</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Unit Price</th>
                        <th style="padding: 12px; text-align: right; border: 1px solid #ddd;">Total Price</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.OrderItems != null && Model.OrderItems.Any())
                    {
                        @foreach (var item in Model.OrderItems)
                        {
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 12px; border: 1px solid #ddd;">@item.Product?.Name</td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">@item.Quantity</td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$@item.UnitPrice.ToString("N2")</td>
                                <td style="padding: 12px; text-align: right; border: 1px solid #ddd;">$@item.TotalPrice.ToString("N2")</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #2d5a5a;">Total Amount:</h3>
                <h2 style="margin: 0; color: #2d5a5a;">$@Model.TotalAmount.ToString("N2")</h2>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.Notes))
        {
            <div style="margin-top: 20px;">
                <h3 style="color: #2d5a5a; border-bottom: 2px solid #2d5a5a; padding-bottom: 10px;">Notes</h3>
                <p style="background: #f8f9fa; padding: 15px; border-radius: 4px;">@Model.Notes</p>
            </div>
        }

        @if (Model.Status != "Cancelled")
        {
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                <h3 style="color: #2d5a5a; margin-bottom: 15px;">Update Status</h3>
                <form method="post" action="/Order/UpdateStatus/@Model.Id" style="display: inline-block; margin-right: 10px;">
                    <select name="status" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                        <option value="Pending" selected="@(Model.Status == "Pending")">Pending</option>
                        <option value="Processing" selected="@(Model.Status == "Processing")">Processing</option>
                        <option value="Shipped" selected="@(Model.Status == "Shipped")">Shipped</option>
                        <option value="Delivered" selected="@(Model.Status == "Delivered")">Delivered</option>
                    </select>
                    <button type="submit" style="background-color: #2d5a5a; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer;">Update Status</button>
                </form>
                <button type="button" onclick="showCancelModal(@Model.Id)" style="background-color: #dc3545; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer;">Cancel Order</button>
            </div>
        }
    </div>
</div>

<style>
    .alert {
        padding: 12px 20px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
</style>

<!-- Beautiful Cancel Order Modal -->
<div id="cancelModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; padding: 0; max-width: 450px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: modalSlideIn 0.3s ease-out;">
        <div style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); padding: 25px; border-radius: 12px 12px 0 0; text-align: center;">
            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-exclamation-triangle" style="font-size: 30px; color: white;"></i>
            </div>
            <h2 style="margin: 0; color: white; font-size: 24px; font-weight: 600;">Cancel Order?</h2>
        </div>
        <div style="padding: 30px;">
            <p style="margin: 0 0 25px 0; color: #555; font-size: 16px; line-height: 1.6; text-align: center;">
                Are you sure you want to cancel this order?<br>
                <strong style="color: #dc3545;">Stock will be rolled back automatically.</strong>
            </p>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button id="confirmCancelBtn" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3); transition: all 0.3s;">
                    Yes, Cancel Order
                </button>
                <button onclick="closeCancelModal()" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s;">
                    No, Keep Order
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentOrderId = @Model.Id;

    function showCancelModal(orderId) {
        currentOrderId = orderId;
        const modal = document.getElementById('cancelModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeCancelModal() {
        const modal = document.getElementById('cancelModal');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    document.getElementById('confirmCancelBtn').addEventListener('click', function() {
        if (currentOrderId) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/Order/Cancel/' + currentOrderId;
            
            // Add anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = token.value;
                form.appendChild(tokenInput);
            }
            
            document.body.appendChild(form);
            form.submit();
        }
    });

    // Close modal when clicking outside
    document.getElementById('cancelModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCancelModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCancelModal();
        }
    });
</script>

<style>
    @@keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translateY(-50px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    #confirmCancelBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4) !important;
    }

    #cancelModal button:last-child:hover {
        background: #e9ecef !important;
        border-color: #adb5bd !important;
    }
</style>

