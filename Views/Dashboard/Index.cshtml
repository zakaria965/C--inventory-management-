@using InventoryManagementSystem.Models
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_DashboardLayout";
}

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">Dashboard</h1>
        <button class="dark-mode-toggle" id="darkModeToggle" aria-label="Toggle dark mode" title="Toggle Dark Mode" style="position: relative; top: 0; left: 0; transform: none;">
            <i class="fas fa-moon" id="darkModeIcon"></i>
            <span id="darkModeText" style="font-size: 14px; font-weight: 600;">Dark Mode</span>
        </button>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["Success"]
        </div>
    }

    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #2d5a5a;">Total Products</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: #2d5a5a;">@ViewBag.Stats.TotalProducts</p>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #2d5a5a;">Total Orders</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: #2d5a5a;">@ViewBag.Stats.TotalOrders</p>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #2d5a5a;">Employees</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: #2d5a5a;">@ViewBag.Stats.TotalEmployees</p>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #d4a574;">Low Stock</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: #d4a574;">@ViewBag.Stats.LowStockProducts</p>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #2d5a5a;">Pending Orders</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: #2d5a5a;">@ViewBag.Stats.PendingOrders</p>
        </div>
        <div class="stat-card" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h3 style="margin: 0; color: #2d5a5a;">Inventory Value</h3>
            <p style="font-size: 24px; font-weight: bold; margin: 10px 0 0 0; color: #2d5a5a;">$@ViewBag.Stats.TotalInventoryValue.ToString("N2")</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #c10922ff 0%, #20c997 100%); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: white;">
            <h3 style="margin: 0; color: white;">Salary Paid</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: white;">$@ViewBag.Stats.TotalSalaryPaid.ToString("N2")</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: white;">
            <h3 style="margin: 0; color: white;">Salary Unpaid</h3>
            <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: white;">$@ViewBag.Stats.TotalSalaryUnpaid.ToString("N2")</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1 0%, #007bff 100%); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 1;">
                <h3 style="margin: 0; color: white; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-truck" style="font-size: 20px;"></i>
                    Total Suppliers
                </h3>
                <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: white;">@ViewBag.Stats.TotalSuppliers</p>
            </div>
        </div>
        @if (ViewBag.Stats.UnreadMessages > 0)
        {
            <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); color: white;">
                <h3 style="margin: 0; color: white;">Unread Messages</h3>
                <p style="font-size: 32px; font-weight: bold; margin: 10px 0 0 0; color: white;">@ViewBag.Stats.UnreadMessages</p>
            </div>
        }
    </div>

    @if (ViewBag.LowStockProducts != null && ((List<Product>)ViewBag.LowStockProducts).Count > 0)
    {
        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #d4a574;">
            <h3 style="margin-top: 0; color: #856404;">⚠️ Low Stock Alert</h3>
            <ul>
                @foreach (var product in (List<Product>)ViewBag.LowStockProducts)
                {
                    <li>@product.Name - Stock: @product.QuantityInStock (Min: @product.MinimumStockLevel)</li>
                }
            </ul>
        </div>
    }

    @if (ViewBag.RecentActivities != null && ((List<dynamic>)ViewBag.RecentActivities).Count > 0)
    {
        <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: #2d5a5a;">Recent Activities</h2>
            <div style="max-height: 400px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Type</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Description</th>
                            <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var activity in (List<dynamic>)ViewBag.RecentActivities)
                        {
                            <tr style="border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; 
                                        background-color: @(activity.Type == "Purchase" ? "#28a745" : activity.Type == "Outgoing" ? "#dc3545" : "#007bff"); 
                                        color: white;">
                                        @activity.Type
                                    </span>
                                </td>
                                <td style="padding: 10px;">@activity.Description</td>
                                <td style="padding: 10px;">@(((DateTime)activity.Date).ToString("yyyy-MM-dd HH:mm"))</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<style>
    .alert {
        padding: 12px 20px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
    }
    .alert-success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    
    /* Dark mode overrides for dashboard */
    body.dark-mode .container {
        background-color: #1a1a1a !important;
    }
    
    body.dark-mode .stat-card[style*="background: white"],
    body.dark-mode .stat-card[style*="background-color: white"] {
        background: #2d2d2d !important;
        background-color: #2d2d2d !important;
        border: 1px solid #404040 !important;
    }
    
    body.dark-mode div[style*="background: white"] {
        background: #2d2d2d !important;
        background-color: #2d2d2d !important;
    }
    
    body.dark-mode [style*="color: #2d5a5a"] {
        color: #e0e0e0 !important;
    }
    
    body.dark-mode [style*="color: #d4a574"] {
        color: #ffc107 !important;
    }
</style>

@section Scripts {
    <script>
        (function() {
            function setupDarkMode() {
                const darkModeToggle = document.getElementById('darkModeToggle');
                const darkModeIcon = document.getElementById('darkModeIcon');
                const darkModeText = document.getElementById('darkModeText');
                const body = document.body;

                if (!darkModeToggle || !darkModeIcon) {
                    console.log('Dark mode elements not found, retrying...');
                    setTimeout(setupDarkMode, 100);
                    return;
                }

                console.log('Dark mode elements found, initializing...');

                // Check if dark mode is saved in localStorage
                const darkModeState = localStorage.getItem('darkMode');
                if (darkModeState === 'enabled') {
                    body.classList.add('dark-mode');
                    darkModeToggle.classList.add('active');
                    darkModeIcon.classList.remove('fa-moon');
                    darkModeIcon.classList.add('fa-sun');
                    if (darkModeText) {
                        darkModeText.textContent = 'Light Mode';
                    }
                } else {
                    if (darkModeText) {
                        darkModeText.textContent = 'Dark Mode';
                    }
                }

                // Function to apply/remove dark mode styles
                function applyDarkModeStyles(isDark) {
                    // Update stat cards with inline styles
                    document.querySelectorAll('.stat-card').forEach(card => {
                        if (isDark) {
                            card.style.setProperty('background', '#2d2d2d', 'important');
                            card.style.setProperty('background-color', '#2d2d2d', 'important');
                            card.style.setProperty('color', '#e0e0e0', 'important');
                        } else {
                            // Check if it has gradient background
                            const computedStyle = window.getComputedStyle(card);
                            const bg = computedStyle.background || computedStyle.backgroundColor;
                            if (bg && bg.includes('gradient')) {
                                // Keep gradient
                            } else {
                                card.style.setProperty('background', 'white', 'important');
                                card.style.setProperty('background-color', 'white', 'important');
                                card.style.removeProperty('color');
                            }
                        }
                    });
                    
                    // Update all white divs
                    document.querySelectorAll('div[style*="background: white"], div[style*="background-color: white"]').forEach(div => {
                        if (isDark) {
                            div.style.setProperty('background', '#2d2d2d', 'important');
                            div.style.setProperty('background-color', '#2d2d2d', 'important');
                            div.style.setProperty('color', '#e0e0e0', 'important');
                        } else {
                            div.style.setProperty('background', 'white', 'important');
                            div.style.setProperty('background-color', 'white', 'important');
                            div.style.removeProperty('color');
                        }
                    });
                    
                    // Update text colors
                    document.querySelectorAll('h1, h2, h3, h4, p, span, td, th, li').forEach(el => {
                        const style = el.getAttribute('style') || '';
                        if (style.includes('color: #2d5a5a') || style.includes('color: #333') || 
                            style.includes('color: #666') || style.includes('color: #999')) {
                            if (isDark) {
                                el.style.setProperty('color', '#e0e0e0', 'important');
                            } else {
                                // Restore original color
                                if (style.includes('color: #2d5a5a')) {
                                    el.style.setProperty('color', '#2d5a5a', 'important');
                                } else if (style.includes('color: #333')) {
                                    el.style.setProperty('color', '#333', 'important');
                                }
                            }
                        }
                    });
                    
                    // Update container
                    const container = document.querySelector('.container');
                    if (container) {
                        if (isDark) {
                            container.style.setProperty('background-color', '#1a1a1a', 'important');
                            container.style.setProperty('color', '#e0e0e0', 'important');
                        } else {
                            container.style.removeProperty('background-color');
                            container.style.removeProperty('color');
                        }
                    }
                    
                    // Update main content and wrapper
                    document.querySelectorAll('.main-content, .content-wrapper, .dashboard-container').forEach(el => {
                        if (isDark) {
                            el.style.setProperty('background-color', '#1a1a1a', 'important');
                        } else {
                            el.style.removeProperty('background-color');
                        }
                    });
                }
                
                // Remove any existing event listeners by replacing onclick
                darkModeToggle.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('Dark mode toggle clicked');
                    
                    body.classList.toggle('dark-mode');
                    darkModeToggle.classList.toggle('active');
                    
                    const isDark = body.classList.contains('dark-mode');
                    
                    if (isDark) {
                        darkModeIcon.classList.remove('fa-moon');
                        darkModeIcon.classList.add('fa-sun');
                        localStorage.setItem('darkMode', 'enabled');
                        if (darkModeText) {
                            darkModeText.textContent = 'Light Mode';
                        }
                        console.log('Dark mode enabled');
                    } else {
                        darkModeIcon.classList.remove('fa-sun');
                        darkModeIcon.classList.add('fa-moon');
                        localStorage.setItem('darkMode', 'disabled');
                        if (darkModeText) {
                            darkModeText.textContent = 'Dark Mode';
                        }
                        console.log('Dark mode disabled');
                    }
                    
                    // Apply dark mode styles directly
                    applyDarkModeStyles(isDark);
                };
                
                // Apply dark mode on initial load if enabled
                if (darkModeState === 'enabled') {
                    setTimeout(() => applyDarkModeStyles(true), 300);
                }
            }

            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupDarkMode);
            } else {
                setupDarkMode();
            }
            
            // Also try after a delay to ensure elements are loaded
            setTimeout(setupDarkMode, 300);
        })();
    </script>
}
